<?xml version="1.0"?>
<Job>
  <Config>
    <ConnectionString>server=HCS-DEV0002;initial catalog=Shared;Trusted_Connection=True;</ConnectionString>
    <MaximumEntitiesToLoad>100</MaximumEntitiesToLoad>
    <EntitiesPerBatch>10</EntitiesPerBatch>
    <EntitiesPerUploadFile>10</EntitiesPerUploadFile>
    <LocalSaveFolder>c:\Catalyst\databus</LocalSaveFolder>
    <DropAndReloadIndex>false</DropAndReloadIndex>
    <WriteTemporaryFilesToDisk>true</WriteTemporaryFilesToDisk>
    <WriteDetailedTemporaryFilesToDisk>true</WriteDetailedTemporaryFilesToDisk>
    <CompressFiles>false</CompressFiles>
    <Index>patients2</Index>
    <Alias>patients</Alias>
    <EntityType>documents</EntityType>
    <TopLevelKeyColumn>KeyLevel1</TopLevelKeyColumn>
    <KeepTemporaryLookupColumnsInOutput>false</KeepTemporaryLookupColumnsInOutput>
  </Config>

  <Data>
    <DataSource Path="$">
      <Sql>
        SELECT Text.TextID,
        Text.TextID            AS [KeyLevel1],
        Text.EDWPatientID      AS [EDWPatientId],
        Text.TextTXT           AS [data],
        Text.MimeTypeNM        AS [data_format],
        Text.TextID            AS [root],
        Text.TextSourceDSC     AS [extension],
        Text.TextOriginTableNM AS [extension_suffix]
        FROM   Text.Text
      </Sql>
    </DataSource>
    <DataSource Path="$">
      <Sql>
        SELECT DISTINCT Date.TextID  AS [KeyLevel1],
        Date.TextID  AS [key],
        Date.TextID  AS [root],
        Date.DateDTS AS [source_last_modified_at],
        Date.DateDTS AS [source_versioned_at]
        FROM   Text.Date
      </Sql>
    </DataSource>
    <DataSource Path="$.patient" PropertyType="object">
      <Sql>
        SELECT DISTINCT
        Text.TextID          AS [KeyLevel1],
        Patient.EDWPatientID AS [KeyLevel2],
        Patient.EDWPatientID AS [key],
        Patient.MRN          AS [MRN],
        PatientFullNM        AS [last_name],/* last name is missing */
        PatientFullNM        AS [first_name],/* first name is missing */
        PatientFullNM        AS [middle_name],
        /* middle name is missing */
        GenderNormDSC        AS [gender],/* gender is null */
        BirthDTS             AS [date_of_birth]
        FROM   Text.Text
        INNER JOIN Person.Patient
        ON Text.EDWPatientID = Patient.EDWPatientID
      </Sql>
    </DataSource>
    <DataSource Path="$.visit" PropertyType="object">
      <Sql>
        SELECT DISTINCT 
        Text.TextID                       AS [KeyLevel1],
        Encounter.EncounterID             AS [KeyLevel2],
        FacilityAccount.FacilityAccountID AS [key],
        /* [root] */
        FacilityAccount.FacilityAccountID AS [extension],
        AdmitDTS                          AS [admitted_at],
        DischargeDTS                      AS [discharged_at]
        FROM   Text.Text
        INNER JOIN Clinical.Encounter
        ON Text.EncounterID = Encounter.EncounterID
        INNER JOIN Clinical.FacilityAccount
        ON Encounter.FacilityAccountID =
        FacilityAccount.FacilityAccountID
      </Sql>
    </DataSource>
    <DataSource Path="$.visit.facility" PropertyType="object">
      <Sql>
        SELECT DISTINCT 
        Text.TextID                       AS [KeyLevel1],
        Encounter.EncounterID             AS [KeyLevel2],
        FacilityAccount.FacilityAccountID AS [KeyLevel3],
        FacilityAccount.FacilityAccountID AS [key],
        DischargePhysicalLocationID       AS [root],
        DischargePhysicalLocationNM       AS [extension]
        /* always null */
        FROM   Text.Text
        INNER JOIN Clinical.Encounter
        ON Text.EncounterID = Encounter.EncounterID
        INNER JOIN Clinical.FacilityAccount
        ON Encounter.FacilityAccountID =
        FacilityAccount.FacilityAccountID
      </Sql>
    </DataSource>
    <DataSource Path="$.visit.people">
      <Sql>
        SELECT DISTINCT Text.TextID       AS [KeyLevel1],
        Encounter.EncounterID             AS [KeyLevel2],
        Provider.EDWProviderID            AS [KeyLevel3],
        FacilityAccount.FacilityAccountID AS [FacilityAccountID],
        /* not always null but null often */
        Provider.EDWProviderID            AS [EDWPerformingProviderID],
        /* role */
        Encounter.RowSourceDSC            AS [EncounterSourceDSC],
        /*EncounterSourceDSC is missing */
        Provider.ProviderLastNM           AS [last_name],
        Provider.ProviderFirstNM          AS [first_name],
        Provider.ProviderMiddleNM         AS [middle_name]
        /* mostly null */
        FROM   Text.Text
        INNER JOIN Clinical.Encounter
        ON Text.EncounterID = Encounter.EncounterID
        INNER JOIN Clinical.FacilityAccount
        ON Encounter.FacilityAccountID =
        FacilityAccount.FacilityAccountID
        INNER JOIN Person.Provider
        ON Provider.EDWProviderID =
        FacilityAccount.EDWAttendingProviderID
      </Sql>
    </DataSource>
    <DataSource Path="$.document" PropertyType="object">
      <Sql>
        SELECT DISTINCT Text.TextID        AS [KeyLevel1],
        Text.TextID        AS [KeyLevel2],
        Text.TextID        AS [key],
        Text.TextID        AS [root],
        Text.TextSourceDSC AS [extension],
        'unknown'          AS [confidentiality_code],
        /* source_created_at */
        /* source_updated_at */
        StatusDSC          AS [Status],
        /* needs to be mapped to unknown, preliminary, final, corrected, addendum, in_error, cancelled */
        Text.TextSourceDSC AS [type_root],
        Text.TextTypeCD    AS [type_extension],
        Text.TextTypeDSC   AS [type_description]
        FROM   Text.Text
      </Sql>
    </DataSource>
    <DataSource Path="$.document" PropertyType="object">
      <Sql>
        SELECT DISTINCT Date.TextID  AS [KeyLevel1],
        Date.TextID  AS [KeyLevel2],
        Date.TextID  AS [key],
        Date.DateDTS AS [date_of_service]
        FROM   Text.Date
      </Sql>
    </DataSource>
    <DataSource Path="$.document.people">
      <Sql>
        SELECT DISTINCT Text.TextID               AS [KeyLevel1],
        Text.TextID               AS [KeyLevel2],
        Provider.EDWProviderID    AS [KeyLevel3],
        /* role */ /* not sure where to map from */
        EDWProviderID             AS [root],
        /* Provider.RowSourceDSC */
        Provider.ProviderLastNM   AS [last_name],
        Provider.ProviderFirstNM  AS [first_name],
        Provider.ProviderMiddleNM AS [middle_name]
        /* middle name is always null */
        FROM   Text.Text
        INNER JOIN Clinical.Encounter
        ON Text.EncounterID = Encounter.EncounterID
        INNER JOIN Clinical.FacilityAccount
        ON Encounter.FacilityAccountID =
        FacilityAccount.FacilityAccountID
        INNER JOIN Person.Provider
        ON Provider.EDWProviderID =
        FacilityAccount.EDWAttendingProviderID
      </Sql>
    </DataSource>
  </Data>
</Job>